<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kimberley WA ‚Äî Live Multi‚ÄëFire Simulation</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    #sidebar { padding: 12px 14px; overflow: auto; border-right: 1px solid #e5e7eb; background: #fafafa; }
    #map { height: 100%; }
    h1 { margin: 0 0 6px; font-size: 18px; }
    h2 { margin: 14px 0 6px; font-size: 16px; }
    .card { background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display: grid; grid-template-columns: 1fr 80px; gap: 8px; align-items: center; }
    .controls { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; }
    button { padding: 8px 10px; border-radius: 10px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; }
    button.primary { background: #0166ff; color: #fff; border-color: #0166ff; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    .legend { font-size: 12px; }
    .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
    .pill { font-size: 12px; background: #f3f4f6; padding: 2px 8px; border-radius: 999px; display:inline-block; }
    .muted { color:#6b7280; }
  </style>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <h1>Kimberley WA ‚Äî Live Multi‚ÄëFire Simulation</h1>
      <div class="card" id="global-card">
        <div class="row"><div>Step (sim minutes)</div><div><span id="stepLabel" class="pill">0</span></div></div>
        <div class="row"><div>Tick speed (ms)</div><div><input id="tickMs" type="number" min="200" step="100" value="1200" style="width:100%"></div></div>
        <div class="row"><div>Step size (mins)</div><div><input id="stepMins" type="number" min="5" step="5" value="30" style="width:100%"></div></div>
        <div class="controls" style="margin-top:8px">
          <button id="playBtn" class="primary">Play</button>
          <button id="pauseBtn">Pause</button>
          <button id="resetBtn">Reset</button>
        </div>
        <div style="margin-top:8px" class="muted">Tip: 30 mins per tick is recommended. Increase tick speed for smoother animation.</div>
      </div>

      <div class="card">
        <h2>Environment</h2>
        <div class="row"><label>Humidity (%)</label><input id="hum" type="range" min="5" max="90" value="25"></div>
        <div class="row"><label>Temperature (¬∞C)</label><input id="temp" type="range" min="20" max="50" value="38"></div>
        <div class="row"><label>Fuel Load (%)</label><input id="fuel" type="range" min="0" max="100" value="60"></div>
        <div class="row"><label>Aggression (0‚Äì100)</label><input id="agg" type="range" min="0" max="100" value="65"></div>
        <div class="muted" style="margin-top:6px">These act as global multipliers applied to all fires.</div>
      </div>

      <div class="card">
        <h2>Fires</h2>
        <div id="firesPanel"></div>
      </div>

      <div class="card">
        <h2>Impact ‚Äî Population & Infrastructure (inside latest fire polygons)</h2>
        <table>
          <thead>
            <tr>
              <th>Fire</th>
              <th>Pop</th>
              <th>Houses</th>
              <th>Infra</th>
            </tr>
          </thead>
          <tbody id="impactBody"></tbody>
        </table>
      </div>

      <div class="card legend">
        <div><span class="dot" style="background:#ef4444"></span>Broome Fire</div>
        <div><span class="dot" style="background:#f59e0b"></span>Derby Fire</div>
        <div><span class="dot" style="background:#10b981"></span>Kununurra Fire</div>
        <div style="margin-top:6px" class="muted">Town markers include rough population & estimated dwellings for demo purposes.
        Replace with your official datasets (ABS grid, G-NAF, critical assets, etc.).</div>
      </div>
    </aside>

    <div id="map"></div>
  </div>

<<<<HEAD
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #getStartedBtn:hover {
      background: #27ae60;
    }
  </style>

  <!-- Accessibility & language toggles -->
  <div class="accessibility-bar" aria-label="Accessibility and language options">
    <button id="darkModeToggle" aria-label="Toggle dark mode" tabindex="0">üåô Dark Mode</button>
    
    <select id="languageSelect" aria-label="Select language" tabindex="0">
      <option value="en">English</option>
      <option value="fr">Fran√ßais</option>
      <option value="es">Espa√±ol</option>
      <option value="de">Deutsch</option>
      <option value="it">Italiano</option>
      <option value="pt">Portugu√™s</option>
      <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
      <option value="jp">Êó•Êú¨Ë™û</option>
      <option value="ko">ÌïúÍµ≠Ïñ¥</option>
      <option value="vi">Ti·∫øng Vi·ªát</option>
      <option value="th">‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
      <option value="id">Bahasa Indonesia</option>
      <option value="zh">‰∏≠Êñá</option>
      <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
      <option value="noongar">Noongar</option>
    </select>
  </div>
  <header>
    <div class="logo-title">
      <a href="/">
        <img src="assets/WhatsApp Image 2025-08-18 at 14.35.52.jpeg" alt="Bushfire Detection Logo" width="60" height="60">
      </a>
      <h1 style="color: red;">Australian Bushfire Alert System</h1>
    </div>
    <nav>
  <a href="index.html" class="active">Home</a>
  <a href="dashboard.html">Dashboard</a>
  <div class="dropdown">
    <a href="#" class="dropdown-toggle" id="operationsMenu" aria-haspopup="true" aria-expanded="false">
      Operations ‚ñº
    </a>
    <div class="dropdown-menu" aria-labelledby="operationsMenu">
      <a href="roster.html">Roster Management</a>
      <a href="vehicle.html">Vehicle Tracking</a>
      <a href="employee.html">Employee Management</a>
      <a href="leave.html">Leave Application</a>
      <a href="compliance.html">Compliance</a>
      <a href="incident-report.html">Incident Report</a>
    </div>
  </div>
  <a href="compliance.html">Compliance</a>
  <a href="hazard.html">Hazard Information</a>
  <a href="about.html">About</a>
    </nav>
  </header>
  <main>
    <!-- Summary Cards Row
    <div class="dashboard-summary-cards" style="display:flex;gap:1em;flex-wrap:wrap;margin-bottom:1.5em;">
      <div class="card" style="min-width:180px;flex:1;">
        <h3>üî• Active Bushfires</h3>
        <div id="summaryActiveFires" style="font-size:2em;font-weight:bold;">0</div>
      </div>
      <div class="card" style="min-width:180px;flex:1;">
        <h3>‚ö†Ô∏è High-Risk Areas</h3>
        <div id="summaryHighRisk" style="font-size:2em;font-weight:bold;">0</div>
      </div>
      <div class="card" style="min-width:180px;flex:1;">
        <h3>üöë Medical Resources</h3>
        <div id="summaryMedResources" style="font-size:2em;font-weight:bold;">0</div>
      </div>
      <div class="card" style="min-width:180px;flex:1;">
        <h3>üå°Ô∏è Weather Risk Index</h3>
        <div id="summaryWeatherRisk" style="font-size:2em;font-weight:bold;">0</div>
      </div>
    </div>
    --->
    <!-- Trend Graphs Row
    <div class="dashboard-trend-graphs" style="display:flex;gap:1em;flex-wrap:wrap;margin-bottom:1.5em;">
      <div class="card" style="flex:1;min-width:280px;">
        <h3>üìà Fire Incidents Trend</h3>
        <div id="trendFireIncidents" style="height:120px;">[Graph]</div>
      </div>
      <div class="card" style="flex:1;min-width:280px;">
        <h3>üõ†Ô∏è Resource Use Trend</h3>
        <div id="trendResourceUse" style="height:120px;">[Graph]</div>
      </div>
      <div class="card" style="flex:1;min-width:280px;">
        <h3>üöë Medical Calls Trend</h3>
        <div id="trendMedicalCalls" style="height:120px;">[Graph]</div>
      </div>
    </div>
    -->
    <div class="dashboard-flex">
      <!-- Incident Trend Line Chart -->
      <section class="card" style="flex:1;min-width:350px;max-width:600px;margin-bottom:2em;">
        <h3>üìà Incident Trends by Type</h3>
        <canvas id="incidentTrendChart" height="220" aria-label="Incident trend line chart"></canvas>
        <div id="incidentTrendChartLegend"></div>
      </section>
      <section class="alerts-list-section" aria-label="Active Alerts">
        <div class="alerts-header">
          <h2>Active Alerts</h2>
          <span class="last-updated" id="alertsLastUpdated">Updated just now</span>
          <button class="refresh-btn" onclick="refreshAlerts()" aria-label="Refresh alerts">üîÑ</button>
          <button class="collapse-btn" id="toggle-alerts" aria-label="Collapse alerts">‚ñº</button>
        </div>
        <div id="alertsFeed" class="alerts-feed" style="margin-bottom:1em;"></div>
        <div id="alertsList" class="alerts-list" role="list"></div>
      </section>
      <!-- Remove or comment out the weather-chat-section from here -->
      <!--
      <section class="weather-chat-section" aria-label="AI Weather Predictor">
        <h2>ü§ñ AI Weather Predictor</h2>
        <div class="quick-questions">
          <h4>Quick Questions:</h4>
          <button class="quick-question-btn" onclick="askWeatherQuestion('What will the weather be like in Perth next week?')">Perth Next Week</button>
          <button class="quick-question-btn" onclick="askWeatherQuestion('What are the fire risk conditions for next week?')">Fire Risk Analysis</button>
          <button class="quick-question-btn" onclick="askWeatherQuestion('Should we pre-position resources based on predicted conditions?')">Resource Planning</button>
        </div>
        <div class="fire-risk-graph" id="fireRiskGraph" aria-label="Fire risk trend graph">
          [Fire risk trend graph will appear here]
        </div>
        <div class="chat-container">
          <div id="chatMessages" class="chat-messages" aria-live="polite">
            <div class="message ai">
              Hello! I'm your AI Weather Predictor. Ask me about weather conditions, fire risk assessments, or operational planning for Perth and surrounding areas. How can I help you today?
            </div>
          </div>
          <div class="chat-input-container">
            <input type="text" id="chatInput" class="chat-input" placeholder="Ask about weather predictions..." maxlength="500" aria-label="Weather chat input" />
            <button id="voiceBtn" class="voice-btn" aria-label="Voice input" tabindex="0">üé§</button>
            <button id="chatSendBtn" class="chat-send-btn" onclick="sendMessage()" aria-label="Send message">Send</button>
          </div>
        </div>
      </section>
      -->
      <!-- Add a button to open the chatbox -->
      <button
        id="openWeatherChatBtn"
        style="
          position: fixed;
          right: 24px;
          bottom: 24px;
          z-index: 999;
          padding: 16px 28px;
          border-radius: 24px;
          background: #0078d7;
          color: #fff;
          border: none;
          font-size: 18px;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        "
      >
        Open Weather Chat
      </button>
      <!-- Chat popup window (initially hidden) -->
        <div
        id="weatherChatPopup"
        title="Try asking: ‚ÄòPerth fire risk next 3 days‚Äô"
        style="
          display: flex;
          position: fixed;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          width: 500px;
          max-width: 90vw;
          height: 600px;
          max-height: 80vh;
          background: #fff;
          border-radius: 16px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.2);
          z-index: 1000;
          flex-direction: column;
          overflow: hidden;
          border: 1px solid rgba(0,0,0,0.1);
        "
      >
        <!-- Chatbox bar/header with close button -->
        <div style="width:100%;background:linear-gradient(135deg, #0078d7, #006cbe);color:#fff;padding:20px 24px;display:flex;align-items:center;justify-content:space-between;position:relative;box-sizing:border-box;border-radius:16px 16px 0 0;">
          <span style="font-weight:600;font-size:1.3rem;padding-left:8px;letter-spacing:0.5px;">Weather Assistant</span>
          <button
            id="closeWeatherChatBtn"
            style="
              background: transparent;
              border: none;
              font-size: 28px;
              color: #fff;
              cursor: pointer;
              margin-right: 8px;
              line-height: 1;
              width: 36px;
              height: 36px;
              display: flex;
              align-items: center;
              justify-content: center;
              position: static;
              z-index: 2;
            "
            aria-label="Close Chat"
          >&#10005;</button>
        </div>
        <!-- Chat content -->
        <div style="padding: 0 0 0 0; height: calc(100% - 48px); overflow: hidden;">
          <section class="weather-chat-section" aria-label="AI Weather Predictor" style="height: 100%; box-shadow: none; border: none; display: flex; flex-direction: column;">
            <h2 style="display:none;">ü§ñ AI Weather Predictor</h2>
            <div class="quick-questions" style="margin-bottom:1.5rem;padding:1rem;background:#f8f9fa;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
              <h4 style="margin:0 0 1rem 0;color:#1a73e8;font-size:1.1rem;">Quick Questions:</h4>
              <div style="display:grid;gap:0.5rem;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));">
                <button class="quick-question-btn" onclick="askWeatherQuestion('What will the weather be like in Perth next week?')" style="background:#e8f0fe;color:#1a73e8;border:1px solid #d2e3fc;padding:0.6rem;border-radius:8px;transition:all 0.2s;cursor:pointer;">Perth Next Week</button>
                <button class="quick-question-btn" onclick="askWeatherQuestion('What are the fire risk conditions for next week?')" style="background:#e8f0fe;color:#1a73e8;border:1px solid #d2e3fc;padding:0.6rem;border-radius:8px;transition:all 0.2s;cursor:pointer;">Fire Risk Analysis</button>
                <button class="quick-question-btn" onclick="askWeatherQuestion('Should we pre-position resources based on predicted conditions?')" style="background:#e8f0fe;color:#1a73e8;border:1px solid #d2e3fc;padding:0.6rem;border-radius:8px;transition:all 0.2s;cursor:pointer;">Resource Planning</button>
              </div>
            </div>
            <div class="fire-risk-graph" id="fireRiskGraph" aria-label="Fire risk trend graph">
              [Fire risk trend graph will appear here]
            </div>
            <div class="chat-container" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
              <div id="chatMessages" class="chat-messages" aria-live="polite" style="flex: 1; overflow-y: auto; margin-bottom: 1rem;">
                <div class="message ai">
                  Hello! I'm your AI Weather Predictor. Ask me about weather conditions, fire risk assessments, or operational planning for Perth and surrounding areas. How can I help you today?
                </div>
              </div>
              <div class="chat-input-container" style="flex-shrink: 0;display:flex;gap:0.5rem;padding:1rem;background:#fff;border-top:1px solid #eee;">
                <input type="text" id="chatInput" class="chat-input" placeholder="Ask about weather predictions..." maxlength="500" aria-label="Weather chat input" style="flex:1;padding:0.8rem;border:1px solid #ddd;border-radius:8px;font-size:1rem;" />
                <button id="voiceBtn" class="voice-btn" aria-label="Voice input" tabindex="0" style="background:#1a73e8;width:40px;height:40px;display:flex;align-items:center;justify-content:center;">üé§</button>
                <button id="chatSendBtn" class="chat-send-btn" onclick="sendMessage()" aria-label="Send message" style="background:#1a73e8;color:white;border:none;padding:0 1.5rem;border-radius:8px;font-size:1rem;cursor:pointer;">Send</button>
              </div>
            </div>
          </section>
        </div>
      </div>
      <div class="map-medical-stack">
        <section class="map-section">
          <h2>Bushfire Behaviour Analysis</h2>
          <!-- Add Find Me/Search bar -->
          <div style="display:flex;align-items:center;gap:0.5em;margin-bottom:0.7em;">
            <input
              id="locationSearchInput"
              type="text"
              placeholder="Search location or address‚Ä¶"
              style="flex:1;padding:0.5em 1em;border-radius:6px;border:1px solid #ccc;font-size:1em;"
              aria-label="Search location"
            />
            <button
              id="findMeBtn"
              style="padding:0.5em 1em;border-radius:6px;background:#1976d2;color:#fff;border:none;cursor:pointer;font-size:1em;"
              aria-label="Find my location"
              title="Find my location"
            >üìç Find Me</button>
          </div>
          <div style="margin-bottom:0.7em;">
            <label><input type="radio" name="mapFilter" value="fires" checked onchange="setMapFilter('fires')"> Fires Only</label>
            <label style="margin-left:1em;"><input type="radio" name="mapFilter" value="medical" onchange="setMapFilter('medical')"> Medical Resources Only</label>
            <label style="margin-left:1em;"><input type="radio" name="mapFilter" value="both" onchange="setMapFilter('both')"> Both</label>
          </div>
          <div id="map" class="map-embed"></div>
          <div style="margin-top:0.5em;">
            <button onclick="toggleFireSpreadLayer()" id="fireSpreadBtn">Show Fire Spread Zones</button>
            <button onclick="toggleRiskLayer()" id="riskLayerBtn" style="margin-left:0.5em;">Show Predicted Risk Areas</button>
          </div>
        </section>
        <section class="medical-emergency-section card">
          <h2>Medical Emergency Integrations</h2>
          <div id="med-integration-tabs" class="med-tabs">
            <button onclick="showMedIntegration(0)">Dispatch Coordination</button>
            <button onclick="showMedIntegration(1)">Health Risk Mapping</button>
            <button onclick="showMedIntegration(2)">Responder Profiles</button>
            <button onclick="showMedIntegration(3)">Health Services</button>
            <button onclick="showMedIntegration(4)">Equipment Tracking</button>
            <button onclick="showMedIntegration(5)">Predictive Alerts</button>
            <button onclick="showMedIntegration(6)">Incident Analytics</button>
            <button onclick="showMedIntegration(7)">Live Status</button>
            <button onclick="showMedIntegration(8)">Request Medical Support</button>
          </div>
          <div id="med-integration-content" class="med-content">
            <!-- Details will appear here -->
          </div>
        </section>
        <!-- Medical Coordination Dashboard -->
        <section class="medical-coordination-dashboard card">
          <h2>üè• Medical Coordination Dashboard</h2>
          <div class="med-coord-tabs" style="display:flex;gap:0.5em;margin-bottom:1em;">
            <button onclick="showMedCoordTab(0)" id="tab-overview">Overview</button>
            <button onclick="showMedCoordTab(1)" id="tab-incidents">Incidents</button>
            <button onclick="showMedCoordTab(2)" id="tab-resources">Resources</button>
            <button onclick="showMedCoordTab(3)" id="tab-comm">Communication</button>
          </div>
          <div id="med-coord-content" class="med-content" style="min-height:200px;">
            <!-- Content will be injected here -->
          </div>
        </section>
        <!-- Emergency Communication Flow Section -->
        <section class="emergency-flow-section card">
          <h2>Emergency Communication Flow</h2>
          <div id="emergency-flow-steps" class="emergency-flow-steps"></div>
          <div class="emergency-flow-nav">
            <button onclick="prevFlowStep()">Previous</button>
            <button onclick="nextFlowStep()">Next</button>
            <button onclick="restartFlowStep()">Restart</button>
          </div>
        </section>
        <!-- Social Media & Community Feed Aggregator -->
        <section class="social-feed-section card" style="margin-top: 1.5em;">
          <h2>Social Media & Community Feed</h2>
          <div class="feed-controls" style="margin-bottom: 1em;">
            <input type="text" id="feedSearchInput" placeholder="Search posts by keyword or location..." style="width: 70%; padding: 0.5em; border-radius: 5px; border: 1px solid #ccc;">
            <button id="filterFeedBtn" style="margin-left: 0.5em;">Filter</button>
            <button id="refreshFeedBtn" style="margin-left: 0.5em;">Refresh</button>
          </div>
          <div id="socialFeed" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 0.5em;">
            <!-- Social media posts will be loaded here -->
            <p style="text-align: center; color: #888;">Loading social media posts...</p>
          </div>
        </section>

        <!-- Recovery Intelligence Board -->
        <section class="recovery-board-section card" style="margin-top: 1.5em;">
          <h2>Recovery Intelligence Board</h2>
          <div class="board-controls" style="margin-bottom: 1em;">
            <select id="infoCategoryFilter" style="margin-right: 1em;">
              <option value="all">All Categories</option>
              <option value="damaged-roads">Damaged Roads</option>
              <option value="community-needs">Community Needs</option>
              <option value="shelter-info">Shelter Information</option>
              <option value="aid-distribution">Aid Distribution</option>
            </select>
            <button id="applyBoardFilter">Apply Filter</button>
          </div>
          <div id="recoveryBoard" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 0.5em;">
            <!-- Filtered intelligence items will be loaded here -->
            <p style="text-align: center; color: #888;">No intelligence items to display.</p>
          </div>
        </section>
      </div>
    </div>
  </main>
  <footer>
    <div style="font-weight:bold;color:#c0392b;">
      ‚ö†Ô∏è Not for Operational Use. For demonstration only.<br>
      Data sources: <a href="https://www.bom.gov.au/" target="_blank">Bureau of Meteorology</a>, <a href="https://afdrs.com.au/" target="_blank">AFDRS</a>, <a href="https://firms.modaps.eosdis.nasa.gov/" target="_blank">NASA FIRMS</a>
    </div>
    <p>Based on AFDRS and the <a href="https://www.australianwarningsystem.com.au/" target="_blank">Australian Warning System</a>.</p>
    <form id="feedbackForm" style="margin-top:1em;" aria-label="Feedback form">
      <label for="feedbackInput">Feedback for improvement:</label>
      <input type="text" id="feedbackInput" maxlength="200" style="width:60%;" aria-label="Feedback input" />
      <button type="submit" aria-label="Submit feedback">Submit</button>
      <span id="feedbackStatus" style="margin-left:1em;color:#1976d2;"></span>
    </form>
  </footer>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="script.js"></script>
  <script src="recovery.js"></script>
=======
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
>>>>>>> 23f438e2197588f6bbc8b5a72b39e17651f7243d
  <script>
    // --- Map ---
    const map = L.map('map', { zoomControl: true }).setView([-17.8, 122.2], 6);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }).addTo(map);

    // --- Demo data: towns / infrastructure ---
    const towns = [
      { name: 'Broome', lat: -17.9614, lng: 122.2359, population: 14500, houses: 6000 },
      { name: 'Derby', lat: -17.3012, lng: 123.6300, population: 3500, houses: 1500 },
      { name: 'Kununurra', lat: -15.7740, lng: 128.7384, population: 6000, houses: 2500 },
      { name: 'Fitzroy Crossing', lat: -18.1965, lng: 125.5669, population: 1200, houses: 500 },
      { name: 'Halls Creek', lat: -18.2247, lng: 127.6698, population: 1400, houses: 600 }
    ];

    const infrastructure = [
      { type: 'Power Substation', lat: -17.955, lng: 122.24 },
      { type: 'Airport', lat: -17.948, lng: 122.235 },
      { type: 'Telecom Hub', lat: -17.303, lng: 123.633 },
      { type: 'Water Treatment', lat: -15.775, lng: 128.742 }
    ];

    // Markers for towns & infrastructure
    const townMarkers = towns.map(t => L.marker([t.lat, t.lng]).bindPopup(`<b>${t.name}</b><br>Pop ${t.population.toLocaleString()}<br>Houses ${t.houses.toLocaleString()}`).addTo(map));
    const infraMarkers = infrastructure.map(i => L.circleMarker([i.lat, i.lng], { radius: 6, color: '#3b82f6' }).bindPopup(`<b>${i.type}</b>`).addTo(map));

    // --- Fire model helpers ---
    const KM_IN_DEG_LAT = 110.574; // ~km per deg latitude
    function metersToDegLat(m) { return (m / 1000) / KM_IN_DEG_LAT; }
    function metersToDegLng(m, latDeg) { return (m / 1000) / (111.320 * Math.cos(latDeg * Math.PI/180)); }

    function ellipsePolygon(lat, lng, majorM, minorM, angleDeg, steps = 90) {
      const pts = [];
      const c = Math.cos(angleDeg * Math.PI/180);
      const s = Math.sin(angleDeg * Math.PI/180);
      for (let i = 0; i < steps; i++) {
        const theta = (i / steps) * Math.PI * 2;
        let x = majorM * Math.cos(theta);
        let y = minorM * Math.sin(theta);
        // rotate
        const xr = x * c - y * s;
        const yr = x * s + y * c;
        // convert to lat/lng
        const lat2 = lat + metersToDegLat(yr);
        const lng2 = lng + metersToDegLng(xr, lat);
        pts.push([lat2, lng2]);
      }
      return pts;
    }

    // Simple rate‚Äëof‚Äëspread function (demo only). Replace with your model.
    function calcAxesMeters(hours, windKmh, fuelPct, aggrPct, humidityPct, tempC) {
      const base = Math.max(0.2, (tempC - humidityPct * 0.1) * 0.02); // warm + dry => faster
      const wind = 0.8 + (windKmh / 40); // 40 km/h doubles ROS approx.
      const fuel = 0.5 + (fuelPct / 200);
      const aggr = 0.5 + (aggrPct / 150);
      const ros = base * wind * fuel * aggr; // km/h equivalent (demo)
      const majorKm = hours * ros * (1.6 + windKmh / 60); // stretch downwind
      const minorKm = hours * ros * 0.7; // crosswind slower
      return { majorM: majorKm * 1000, minorM: minorKm * 1000 };
    }

    // --- Fire definitions (different regions of Kimberley) ---
    const fires = [
      {
<<<<<<< HEAD
        title: "Bushfire",
        level: "Emergency",
        status: "Immediate Threat",
        locationDesc: "PERTH METROPOLITAN, CITY OF SWAN",
        updated: Date.now() - 1000 * 60 * 5, // 5 minutes ago
        details: "There is a bushfire in your area. You are in danger and need to act immediately to survive. Leave now if the path is clear. If you cannot leave, you need to shelter."

        id: 'broome', name: 'Broome Fire', color: '#ef4444', center: [-17.95, 122.24],
        params: { windKmh: 25, windDir: 100 }, layer: null, step: 0
>>>>>>> 23f438e2197588f6bbc8b5a72b39e17651f7243d
      },
      {
        id: 'derby', name: 'Derby Fire', color: '#f59e0b', center: [-17.30, 123.63],
        params: { windKmh: 35, windDir: 60 }, layer: null, step: 0
      },
      {
        id: 'kununurra', name: 'Kununurra Fire', color: '#10b981', center: [-15.78, 128.74],
        params: { windKmh: 18, windDir: 120 }, layer: null, step: 0
      }
    ];

    // Per‚Äëfire UI in sidebar
    const firesPanel = document.getElementById('firesPanel');
    fires.forEach((f, idx) => {
      const el = document.createElement('div');
      el.className = 'card';
      el.style.margin = '8px 0';
      el.innerHTML = `
        <div class="row"><div><span class="dot" style="background:${f.color}"></span><b>${f.name}</b></div><div></div></div>
        <div class="row"><label>Wind (km/h)</label><input type="range" min="0" max="80" value="${f.params.windKmh}" data-fire="${idx}" data-k="windKmh"></div>
        <div class="row"><label>Wind Dir (¬∞ from N)</label><input type="range" min="0" max="359" value="${f.params.windDir}" data-fire="${idx}" data-k="windDir"></div>
      `;
      firesPanel.appendChild(el);
    });

    firesPanel.addEventListener('input', (e) => {
      if (e.target && e.target.dataset && e.target.dataset.fire !== undefined) {
        const fire = fires[Number(e.target.dataset.fire)];
        fire.params[e.target.dataset.k] = Number(e.target.value);
      }
    });

    // Global environment sliders
    const hum = document.getElementById('hum');
    const temp = document.getElementById('temp');
    const fuel = document.getElementById('fuel');
    const agg  = document.getElementById('agg');

    // Simulation timing
    let timer = null;
    const stepLabel = document.getElementById('stepLabel');

    function tick() {
      const stepMins = Number(document.getElementById('stepMins').value);
      fires.forEach(fire => {
        fire.step += stepMins; // minutes per tick
        const hours = fire.step / 60;
        const { majorM, minorM } = calcAxesMeters(
          hours, fire.params.windKmh, Number(fuel.value), Number(agg.value), Number(hum.value), Number(temp.value)
        );
        const poly = ellipsePolygon(fire.center[0], fire.center[1], majorM, minorM, fire.params.windDir);

        // Draw / update polygon
        if (fire.layer) map.removeLayer(fire.layer);
        fire.layer = L.polygon(poly, {
          color: fire.color, weight: 2, fillColor: fire.color, fillOpacity: 0.25
        }).addTo(map);

        fire.geojson = turf.polygon([[...poly.map(p=>[p[1], p[0]]), [poly[0][1], poly[0][0]]]]); // lng,lat order
      });

      // Update impacts
      recalcImpacts();
      // UI label
      stepLabel.textContent = fires[0].step + ' min';
    }

    function play() {
      if (timer) return;
      const tickMs = Number(document.getElementById('tickMs').value);
      timer = setInterval(tick, tickMs);
    }

    function pause() { if (timer) { clearInterval(timer); timer = null; } }

    function reset() {
      pause();
      fires.forEach(f => { f.step = 0; if (f.layer) { map.removeLayer(f.layer); f.layer = null; } });
      stepLabel.textContent = '0';
      impactBody.innerHTML = '';
      // reset marker styles
      townMarkers.forEach(m => m.setIcon(new L.Icon.Default()));
      infraMarkers.forEach(m => m.setStyle({ color: '#3b82f6' }));
    }

    document.getElementById('playBtn').onclick = play;
    document.getElementById('pauseBtn').onclick = pause;
    document.getElementById('resetBtn').onclick = reset;

    // --- Impacts ---
    const impactBody = document.getElementById('impactBody');

    function recalcImpacts() {
      impactBody.innerHTML = '';
      const totals = {};

      fires.forEach((fire, idx) => {
        if (!fire.geojson) return;
        let pop = 0, houses = 0, infra = 0;

        towns.forEach((t, i) => {
          const pt = turf.point([t.lng, t.lat]);
          if (turf.booleanPointInPolygon(pt, fire.geojson)) {
            pop += t.population; houses += t.houses;
            // highlight marker (simple style change)
            townMarkers[i].setIcon(new L.Icon({
              iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
              iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34],
              shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png', shadowSize: [41,41]
            }));
          }
        });

        infrastructure.forEach((i, j) => {
          const pt = turf.point([i.lng, i.lat]);
          if (turf.booleanPointInPolygon(pt, fire.geojson)) {
            infra += 1;
            infraMarkers[j].setStyle({ color: fire.color });
          }
        });

        totals[fire.id] = { pop, houses, infra };

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="dot" style="background:${fire.color}"></span>${fire.name}</td>
          <td>${pop.toLocaleString()}</td>
          <td>${houses.toLocaleString()}</td>
          <td>${infra}</td>
        `;
        impactBody.appendChild(tr);
      });
    }

    // Fit map to all content
    const group = L.featureGroup([
      ...townMarkers,
      ...infraMarkers,
      ...fires.map(f => L.marker(f.center))
    ]);
    map.fitBounds(group.getBounds().pad(0.2));
  </script>
</body>
</html>
