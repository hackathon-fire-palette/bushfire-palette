<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Australian Bushfire Alert System</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
  <meta name="theme-color" content="#c0392b" />
  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />
  <style>
    /* --- Existing styles --- */
    .dashboard-flex {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
    }
    .alerts-list-section {
      flex: 1 1 30%;
      max-width: 450px;
      min-width: 300px;
      margin-bottom: 2rem;
    }
    .map-medical-stack {
      display: flex;
      flex-direction: column;
      flex: 2 1 65%;
      min-width: 300px;
      gap: 1rem;
    }
    .map-section, .medical-emergency-section {
      margin-bottom: 0;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      border: 1px solid #e0e0e0;
      padding: 1.5rem;
    }
    .medical-emergency-section h2 {
      margin-top: 0;
      font-size: 1.3rem;
      color: #c0392b;
      letter-spacing: 0.5px;
    }
    .med-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .med-tabs button {
      background: #c0392b;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 0.5em 1em;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
    }
    .med-tabs button:hover, .med-tabs button.active {
      background: #e74c3c;
    }
    .med-content {
      border: 1px solid #e0e0e0;
      background: #f9f9f9;
      border-radius: 7px;
      padding: 1em;
      min-height: 120px;
      font-size: 1em;
      color: #333;
      box-shadow: 0 1px 4px rgba(0,0,0,0.03);
    }
    header, footer {
      padding: 1rem 2rem;
    }
    .logo-title {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    nav {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    nav a {
      text-decoration: none;
      color: #333;
      padding: 0.5em 1em;
      border-radius: 5px;
      transition: background 0.2s;
    }
    nav a.active, nav a:hover {
      background: #c0392b;
      color: #fff;
    }
    /* Emergency Communication Flow styles */
    .emergency-flow-section {
      margin-top: 1rem;
    }
    .emergency-flow-steps {
      display: flex;
      gap: 1rem;
      justify-content: center;
      align-items: flex-end;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .emergency-step-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f5f5f5;
      border-radius: 8px;
      padding: 1rem 0.7rem;
      min-width: 110px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      border: 2px solid transparent;
      transition: border 0.2s, background 0.2s;
      opacity: 0.6;
    }
    .emergency-step-card.active {
      border: 2px solid #c0392b;
      background: #fff3f0;
      opacity: 1;
    }
    .emergency-step-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    .emergency-step-title {
      font-weight: bold;
      margin-bottom: 0.3rem;
      font-size: 1.05rem;
      text-align: center;
    }
    .emergency-step-desc {
      font-size: 0.95rem;
      text-align: center;
      color: #555;
    }
    .emergency-flow-nav {
      display: flex;
      gap: 0.7rem;
      justify-content: center;
      margin-top: 0.5rem;
    }
    .emergency-flow-nav button {
      background: #c0392b;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 0.4em 1em;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
    }
    .emergency-flow-nav button:hover {
      background: #e74c3c;
    }
    /* Responsive styles */
    @media (max-width: 900px) {
      .dashboard-flex {
        flex-direction: column;
        gap: 1.5rem;
      }
      .alerts-list-section,
      .map-medical-stack {
        max-width: 100%;
        min-width: 0;
      }
    }
    @media (max-width: 600px) {
      header, footer {
        padding: 1rem;
      }
      .logo-title h1 {
        font-size: 1.1rem;
      }
      .card {
        padding: 1rem;
      }
      .med-tabs button {
        font-size: 0.95em;
        padding: 0.4em 0.7em;
      }
      .med-content {
        font-size: 0.95em;
        padding: 0.7em;
      }
      nav {
        gap: 0.5rem;
      }
      .emergency-flow-steps {
        flex-direction: column;
        align-items: stretch;
      }
      .emergency-step-card {
        min-width: 0;
        width: 100%;
      }
    }
    /* --- New styles --- */
    body.dark-mode {
      background: #181818;
      color: #f2f2f2;
    }
    .card, .alerts-list, .med-content, .emergency-step-card {
      background: var(--card-bg, #fff);
      color: var(--card-color, #333);
    }
    body.dark-mode .card, body.dark-mode .alerts-list, body.dark-mode .med-content, body.dark-mode .emergency-step-card {
      --card-bg: #232323;
      --card-color: #f2f2f2;
      border-color: #444;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    }
    .high-contrast {
      background: #000 !important;
      color: #fff !important;
    }
    .alerts-list .alert-card {
      border-radius: 8px;
      margin-bottom: 1em;
      padding: 1em;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      border-left: 8px solid #ccc;
      background: #fff;
      transition: background 0.2s, border-color 0.2s;
      display: flex;
      flex-direction: column;
      gap: 0.3em;
    }
    .alert-card[data-level="Emergency"] { border-color: #c0392b; background: #fff3f0; }
    .alert-card[data-level="Watch and Act"] { border-color: #f39c12; background: #fffbe6; }
    .alert-card[data-level="Advice"] { border-color: #1976d2; background: #e6f0ff; }
    .alert-card .alert-title { font-weight: bold; font-size: 1.1em; }
    .alert-card .alert-status { font-size: 0.95em; }
    .alert-card .alert-updated { font-size: 0.9em; color: #888; }
    .alert-card .alert-icon {
      margin-right: 0.5em;
      vertical-align: middle;
    }
    .alerts-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1em;
    }
    .alerts-header .last-updated {
      font-size: 0.95em;
      color: #888;
    }
    .alerts-header .refresh-btn {
      background: #c0392b;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 0.3em 0.8em;
      cursor: pointer;
      font-size: 1em;
      margin-left: 0.5em;
    }
    .alerts-list-section.collapsed .alerts-list {
      display: none;
    }
    .alert-card .alert-content {
      display: none;
    }
    .alert-card[data-expanded="true"] .alert-content {
      display: block;
    }
    .alert-card .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .alert-card .toggle-btn {
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      color: #555;
      padding: 0;
    }
    .alerts-list-section .collapse-btn {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 0.3em 0.8em;
      cursor: pointer;
      font-size: 1em;
      margin-left: 0.5em;
    }
    /* Accessibility toggles */
    .accessibility-bar {
      display: flex;
      gap: 1em;
      align-items: center;
      margin-bottom: 1em;
      justify-content: flex-end;
    }
    .accessibility-bar button, .accessibility-bar select {
      background: #eee;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 0.3em 0.8em;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
    }
    .accessibility-bar button.active, .accessibility-bar button:focus {
      background: #c0392b;
      color: #fff;
      outline: 2px solid #c0392b;
    }
    /* Voice input button */
    .voice-btn {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 2.2em;
      height: 2.2em;
      font-size: 1.3em;
      cursor: pointer;
      margin-left: 0.5em;
      vertical-align: middle;
      transition: background 0.2s;
    }
    .voice-btn.listening {
      background: #f39c12;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 #f39c12; }
      70% { box-shadow: 0 0 0 10px #f39c1200; }
      100% { box-shadow: 0 0 0 0 #f39c12; }
    }
    /* Fire risk graph placeholder */
    .fire-risk-graph {
      width: 100%;
      height: 140px;
      background: linear-gradient(90deg,#e6f0ff,#fffbe6,#fff3f0);
      border-radius: 8px;
      margin: 1em 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #888;
      font-size: 1.1em;
      border: 1px solid #e0e0e0;
    }
    .dashboard-summary-cards {
      background: linear-gradient(90deg, #ff6a00 0%, #ffd194 100%);
      padding: 1em 0.5em;
      border-radius: 12px;
      margin-bottom: 1.5em;
    }
    .dashboard-summary-cards .card {
      background: rgba(255,255,255,0.85);
      color: #333;
      box-shadow: 0 2px 8px rgba(255,106,0,0.08);
      border: 1px solid #ffd194;
    }
    .dashboard-trend-graphs {
      background: linear-gradient(90deg, #ffd194 0%, #ff6a00 100%);
      padding: 1em 0.5em;
      border-radius: 12px;
      margin-bottom: 1.5em;
    }
    .dashboard-trend-graphs .card {
      background: rgba(255,255,255,0.92);
      color: #333;
      box-shadow: 0 2px 8px rgba(255,106,0,0.06);
      border: 1px solid #ffd194;
    }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-toggle {
      text-decoration: none;
      color: #333;
      padding: 0.5em 1em;
      border-radius: 5px;
      transition: background 0.2s;
      cursor: pointer;
      display: inline-block;
    }
    .dropdown-toggle:hover,
    .dropdown-toggle:focus {
      background: #c0392b;
      color: #fff;
    }
    .dropdown-menu {
      display: none;
      position: absolute;
      left: 0;
      top: 110%;
      min-width: 200px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.13);
      z-index: 100;
      flex-direction: column;
      padding: 0.5em 0;
    }
    .dropdown-menu a {
      display: block;
      padding: 0.6em 1.2em;
      color: #333;
      text-decoration: none;
      border-radius: 0;
      background: none;
      transition: background 0.2s;
    }
    .dropdown-menu a:hover,
    .dropdown-menu a:focus {
      background: #f2f2f2;
      color: #c0392b;
    }
    .dropdown:hover .dropdown-menu,
    .dropdown:focus-within .dropdown-menu {
      display: flex;
    }
    /* New styles for alert cards */
    .alerts-list .alert-card {
      border-radius: 8px;
      margin-bottom: 1em;
      padding: 1em;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      border-left: 8px solid #ccc;
      background: #fff;
      transition: background 0.2s, border-color 0.2s;
      display: flex;
      flex-direction: column;
      gap: 0.3em;
    }
    .alert-card[data-level="Emergency"] { border-color: #c0392b; background: #fff3f0; }
    .alert-card[data-level="Watch and Act"] { border-color: #f39c12; background: #fffbe6; }
    .alert-card[data-level="Advice"] { border-color: #1976d2; background: #e6f0ff; }
    .alert-card .alert-title { font-weight: bold; font-size: 1.1em; }
    .alert-card .alert-status { font-size: 0.95em; }
    .alert-card .alert-updated { font-size: 0.9em; color: #888; }
    .alerts-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1em;
    }
    .alerts-header .last-updated {
      font-size: 0.95em;
      color: #888;
    }
    .alerts-header .refresh-btn {
      background: #c0392b;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 0.3em 0.8em;
      cursor: pointer;
      font-size: 1em;
      margin-left: 0.5em;
    }
    .alerts-list-section.collapsed .alerts-list {
      display: none;
    }
    .alert-card .alert-content {
      display: none;
    }
    .alert-card[data-expanded="true"] .alert-content {
      display: block;
    }
    .alert-card .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .alert-card .toggle-btn {
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      color: #555;
      padding: 0;
    }
    .alerts-list-section .collapse-btn {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 0.3em 0.8em;
      cursor: pointer;
      font-size: 1em;
      margin-left: 0.5em;
    }
  </style>
  <!-- Add Leaflet.markercluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
</head>
<body>
  <!-- Welcome Overlay -->
  <div id="welcomeOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    box-sizing: border-box;
  ">
    <div style="
      background: #c0392b;
      padding: 40px;
      border-radius: 15px;
      max-width: 700px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      animation: fadeIn 0.5s ease-out;
    ">
      <h2 style="font-size: 2.5em; margin-bottom: 20px;">Welcome to Bushfire Palette!</h2>
      <p style="font-size: 1.2em; line-height: 1.6; margin-bottom: 30px;">
        Your comprehensive tool for bushfire management and emergency response.
        Explore modules like:
      </p>
      <ul style="list-style: none; padding: 0; margin-bottom: 30px; font-size: 1.1em;">
        <li style="margin-bottom: 10px;"><strong>AI Weather Predictor:</strong> Get real-time weather insights and fire risk forecasts.</li>
        <li style="margin-bottom: 10px;"><strong>Fire Spread Zones:</strong> Visualize potential fire paths and affected areas on the map.</li>
        <li style="margin-bottom: 10px;"><strong>Medical Dispatch Coordination:</strong> Manage medical resources and emergency responses efficiently.</li>
        <li><strong>Roster & Vehicle Management:</strong> Track personnel and vehicles for optimal deployment.</li>
      </ul>
      <button id="getStartedBtn" style="
        background: #2ecc71;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 1.3em;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease;
      ">Get Started</button>
    </div>
  </div>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #getStartedBtn:hover {
      background: #27ae60;
    }
  </style>

  <!-- Accessibility & language toggles -->
  <div class="accessibility-bar" aria-label="Accessibility and language options">
    <button id="darkModeToggle" aria-label="Toggle dark mode" tabindex="0">🌙 Dark Mode</button>
    <button id="contrastToggle" aria-label="Toggle high contrast" tabindex="0">⬛ High Contrast</button>
    <select id="languageSelect" aria-label="Select language" tabindex="0">
      <option value="en">English</option>
      <option value="fr">Français</option>
      <option value="es">Español</option>
      <option value="de">Deutsch</option>
      <option value="it">Italiano</option>
      <option value="pt">Português</option>
      <option value="hi">हिन्दी</option>
      <option value="jp">日本語</option>
      <option value="ko">한국어</option>
      <option value="vi">Tiếng Việt</option>
      <option value="th">ภาษาไทย</option>
      <option value="id">Bahasa Indonesia</option>
      <option value="zh">中文</option>
      <option value="ar">العربية</option>
      <option value="noongar">Noongar</option>
    </select>
  </div>
  <header>
    <div class="logo-title">
      <a href="/">
        <img src="assets/WhatsApp Image 2025-08-18 at 14.35.52.jpeg" alt="Bushfire Detection Logo" width="60" height="60">
      </a>
      <h1 style="color: red;">Australian Bushfire Alert System</h1>
    </div>
    <nav>
  <a href="index.html" class="active">Dashboard</a>
  <div class="dropdown">
    <a href="#" class="dropdown-toggle" id="operationsMenu" aria-haspopup="true" aria-expanded="false">
      Operations ▼
    </a>
    <div class="dropdown-menu" aria-labelledby="operationsMenu">
      <a href="roster.html">Roster Management</a>
      <a href="vehicle.html">Vehicle Tracking</a>
      <a href="employee.html">Employee Management</a>
      <a href="leave.html">Leave Application</a>
      <a href="compliance.html">Compliance</a>
      <a href="incident-report.html">Incident Report</a>
    </div>
  </div>
  <a href="compliance.html">Compliance</a>
  <a href="hazard.html">Hazard Information</a>
  <a href="about.html">About</a>
    </nav>
  </header>
  <main>
    <!-- Summary Cards Row
    <div class="dashboard-summary-cards" style="display:flex;gap:1em;flex-wrap:wrap;margin-bottom:1.5em;">
      <div class="card" style="min-width:180px;flex:1;">
        <h3>🔥 Active Bushfires</h3>
        <div id="summaryActiveFires" style="font-size:2em;font-weight:bold;">0</div>
      </div>
      <div class="card" style="min-width:180px;flex:1;">
        <h3>⚠️ High-Risk Areas</h3>
        <div id="summaryHighRisk" style="font-size:2em;font-weight:bold;">0</div>
      </div>
      <div class="card" style="min-width:180px;flex:1;">
        <h3>🚑 Medical Resources</h3>
        <div id="summaryMedResources" style="font-size:2em;font-weight:bold;">0</div>
      </div>
      <div class="card" style="min-width:180px;flex:1;">
        <h3>🌡️ Weather Risk Index</h3>
        <div id="summaryWeatherRisk" style="font-size:2em;font-weight:bold;">0</div>
      </div>
    </div>
    --->
    <!-- Trend Graphs Row
    <div class="dashboard-trend-graphs" style="display:flex;gap:1em;flex-wrap:wrap;margin-bottom:1.5em;">
      <div class="card" style="flex:1;min-width:280px;">
        <h3>📈 Fire Incidents Trend</h3>
        <div id="trendFireIncidents" style="height:120px;">[Graph]</div>
      </div>
      <div class="card" style="flex:1;min-width:280px;">
        <h3>🛠️ Resource Use Trend</h3>
        <div id="trendResourceUse" style="height:120px;">[Graph]</div>
      </div>
      <div class="card" style="flex:1;min-width:280px;">
        <h3>🚑 Medical Calls Trend</h3>
        <div id="trendMedicalCalls" style="height:120px;">[Graph]</div>
      </div>
    </div>
    -->
    <div class="dashboard-flex">
      <section class="alerts-list-section" aria-label="Active Alerts">
        <div class="alerts-header">
          <h2>Active Alerts</h2>
          <span class="last-updated" id="alertsLastUpdated">Updated just now</span>
          <button class="refresh-btn" onclick="refreshAlerts()" aria-label="Refresh alerts">🔄</button>
          <button class="collapse-btn" id="toggle-alerts" aria-label="Collapse alerts">▼</button>
        </div>
        <div id="alertsFeed" class="alerts-feed" style="margin-bottom:1em;"></div>
        <div id="alertsList" class="alerts-list" role="list"></div>
      </section>
      <!-- Remove or comment out the weather-chat-section from here -->
      <!--
      <section class="weather-chat-section" aria-label="AI Weather Predictor">
        <h2>🤖 AI Weather Predictor</h2>
        <div class="quick-questions">
          <h4>Quick Questions:</h4>
          <button class="quick-question-btn" onclick="askWeatherQuestion('What will the weather be like in Perth next week?')">Perth Next Week</button>
          <button class="quick-question-btn" onclick="askWeatherQuestion('What are the fire risk conditions for next week?')">Fire Risk Analysis</button>
          <button class="quick-question-btn" onclick="askWeatherQuestion('Should we pre-position resources based on predicted conditions?')">Resource Planning</button>
        </div>
        <div class="fire-risk-graph" id="fireRiskGraph" aria-label="Fire risk trend graph">
          [Fire risk trend graph will appear here]
        </div>
        <div class="chat-container">
          <div id="chatMessages" class="chat-messages" aria-live="polite">
            <div class="message ai">
              Hello! I'm your AI Weather Predictor. Ask me about weather conditions, fire risk assessments, or operational planning for Perth and surrounding areas. How can I help you today?
            </div>
          </div>
          <div class="chat-input-container">
            <input type="text" id="chatInput" class="chat-input" placeholder="Ask about weather predictions..." maxlength="500" aria-label="Weather chat input" />
            <button id="voiceBtn" class="voice-btn" aria-label="Voice input" tabindex="0">🎤</button>
            <button id="chatSendBtn" class="chat-send-btn" onclick="sendMessage()" aria-label="Send message">Send</button>
          </div>
        </div>
      </section>
      -->
      <!-- Add a button to open the chatbox -->
      <button
        id="openWeatherChatBtn"
        style="
          position: fixed;
          right: 24px;
          bottom: 24px;
          z-index: 999;
          padding: 16px 28px;
          border-radius: 24px;
          background: #0078d7;
          color: #fff;
          border: none;
          font-size: 18px;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        "
      >
        Open Weather Chat
      </button>
      <!-- Chat popup window (initially hidden) -->
      <div
        id="weatherChatPopup"
        title="Try asking: ‘Perth fire risk next 3 days’"
        style="
          display: none;
          position: fixed;
          right: 24px;
          bottom: 80px;
          width: 350px;
          max-width: 95vw;
          height: 500px;
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 2px 16px rgba(0,0,0,0.3);
          z-index: 1000;
          flex-direction: column;
          overflow: visible;
        "
      >
        <!-- Chatbox bar/header with close button -->
        <div style="width:100%;background:#0078d7;color:#fff;padding:10px 16px 10px 0;display:flex;align-items:center;justify-content:space-between;position:relative;box-sizing:border-box;">
          <span style="font-weight:bold;padding-left:16px;">AI Weather Predictor</span>
          <button
            id="closeWeatherChatBtn"
            style="
              background: transparent;
              border: none;
              font-size: 28px;
              color: #fff;
              cursor: pointer;
              margin-right: 8px;
              line-height: 1;
              width: 36px;
              height: 36px;
              display: flex;
              align-items: center;
              justify-content: center;
              position: static;
              z-index: 2;
            "
            aria-label="Close Chat"
          >&#10005;</button>
        </div>
        <!-- Chat content -->
        <div style="padding: 0 0 0 0; height: calc(100% - 48px); overflow: hidden;">
          <section class="weather-chat-section" aria-label="AI Weather Predictor" style="height: 100%; box-shadow: none; border: none;">
            <h2 style="display:none;">🤖 AI Weather Predictor</h2>
            <div class="quick-questions">
              <h4>Quick Questions:</h4>
              <button class="quick-question-btn" onclick="askWeatherQuestion('What will the weather be like in Perth next week?')">Perth Next Week</button>
              <button class="quick-question-btn" onclick="askWeatherQuestion('What are the fire risk conditions for next week?')">Fire Risk Analysis</button>
              <button class="quick-question-btn" onclick="askWeatherQuestion('Should we pre-position resources based on predicted conditions?')">Resource Planning</button>
            </div>
            <div class="fire-risk-graph" id="fireRiskGraph" aria-label="Fire risk trend graph">
              [Fire risk trend graph will appear here]
            </div>
            <div class="chat-container">
              <div id="chatMessages" class="chat-messages" aria-live="polite">
                <div class="message ai">
                  Hello! I'm your AI Weather Predictor. Ask me about weather conditions, fire risk assessments, or operational planning for Perth and surrounding areas. How can I help you today?
                </div>
              </div>
              <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Ask about weather predictions..." maxlength="500" aria-label="Weather chat input" />
                <button id="voiceBtn" class="voice-btn" aria-label="Voice input" tabindex="0">🎤</button>
                <button id="chatSendBtn" class="chat-send-btn" onclick="sendMessage()" aria-label="Send message">Send</button>
              </div>
            </div>
          </section>
        </div>
      </div>
      <div class="map-medical-stack">
        <section class="map-section">
          <h2>Current Bushfire Alerts</h2>
          <!-- Add Find Me/Search bar -->
          <div style="display:flex;align-items:center;gap:0.5em;margin-bottom:0.7em;">
            <input
              id="locationSearchInput"
              type="text"
              placeholder="Search location or address…"
              style="flex:1;padding:0.5em 1em;border-radius:6px;border:1px solid #ccc;font-size:1em;"
              aria-label="Search location"
            />
            <button
              id="findMeBtn"
              style="padding:0.5em 1em;border-radius:6px;background:#1976d2;color:#fff;border:none;cursor:pointer;font-size:1em;"
              aria-label="Find my location"
              title="Find my location"
            >📍 Find Me</button>
          </div>
          <div style="margin-bottom:0.7em;">
            <label><input type="radio" name="mapFilter" value="fires" checked onchange="setMapFilter('fires')"> Fires Only</label>
            <label style="margin-left:1em;"><input type="radio" name="mapFilter" value="medical" onchange="setMapFilter('medical')"> Medical Resources Only</label>
            <label style="margin-left:1em;"><input type="radio" name="mapFilter" value="both" onchange="setMapFilter('both')"> Both</label>
          </div>
          <div id="map" class="map-embed"></div>
          <div style="margin-top:0.5em;">
            <button onclick="toggleFireSpreadLayer()" id="fireSpreadBtn">Show Fire Spread Zones</button>
            <button onclick="toggleRiskLayer()" id="riskLayerBtn" style="margin-left:0.5em;">Show Predicted Risk Areas</button>
          </div>
        </section>
        <section class="medical-emergency-section card">
          <h2>Medical Emergency Integrations</h2>
          <div id="med-integration-tabs" class="med-tabs">
            <button onclick="showMedIntegration(0)">Dispatch Coordination</button>
            <button onclick="showMedIntegration(1)">Health Risk Mapping</button>
            <button onclick="showMedIntegration(2)">Responder Profiles</button>
            <button onclick="showMedIntegration(3)">Health Services</button>
            <button onclick="showMedIntegration(4)">Equipment Tracking</button>
            <button onclick="showMedIntegration(5)">Predictive Alerts</button>
            <button onclick="showMedIntegration(6)">Incident Analytics</button>
            <button onclick="showMedIntegration(7)">Live Status</button>
            <button onclick="showMedIntegration(8)">Request Medical Support</button>
          </div>
          <div id="med-integration-content" class="med-content">
            <!-- Details will appear here -->
          </div>
        </section>
        <!-- Medical Coordination Dashboard -->
        <section class="medical-coordination-dashboard card">
          <h2>🏥 Medical Coordination Dashboard</h2>
          <div class="med-coord-tabs" style="display:flex;gap:0.5em;margin-bottom:1em;">
            <button onclick="showMedCoordTab(0)" id="tab-overview">Overview</button>
            <button onclick="showMedCoordTab(1)" id="tab-incidents">Incidents</button>
            <button onclick="showMedCoordTab(2)" id="tab-resources">Resources</button>
            <button onclick="showMedCoordTab(3)" id="tab-comm">Communication</button>
          </div>
          <div id="med-coord-content" class="med-content" style="min-height:200px;">
            <!-- Content will be injected here -->
          </div>
        </section>
        <!-- Emergency Communication Flow Section -->
        <section class="emergency-flow-section card">
          <h2>Emergency Communication Flow</h2>
          <div id="emergency-flow-steps" class="emergency-flow-steps"></div>
          <div class="emergency-flow-nav">
            <button onclick="prevFlowStep()">Previous</button>
            <button onclick="nextFlowStep()">Next</button>
            <button onclick="restartFlowStep()">Restart</button>
          </div>
        </section>
        <!-- Social Media & Community Feed Aggregator -->
        <section class="social-feed-section card" style="margin-top: 1.5em;">
          <h2>Social Media & Community Feed</h2>
          <div class="feed-controls" style="margin-bottom: 1em;">
            <input type="text" id="feedSearchInput" placeholder="Search posts by keyword or location..." style="width: 70%; padding: 0.5em; border-radius: 5px; border: 1px solid #ccc;">
            <button id="filterFeedBtn" style="margin-left: 0.5em;">Filter</button>
            <button id="refreshFeedBtn" style="margin-left: 0.5em;">Refresh</button>
          </div>
          <div id="socialFeed" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 0.5em;">
            <!-- Social media posts will be loaded here -->
            <p style="text-align: center; color: #888;">Loading social media posts...</p>
          </div>
        </section>

        <!-- Recovery Intelligence Board -->
        <section class="recovery-board-section card" style="margin-top: 1.5em;">
          <h2>Recovery Intelligence Board</h2>
          <div class="board-controls" style="margin-bottom: 1em;">
            <select id="infoCategoryFilter" style="margin-right: 1em;">
              <option value="all">All Categories</option>
              <option value="damaged-roads">Damaged Roads</option>
              <option value="community-needs">Community Needs</option>
              <option value="shelter-info">Shelter Information</option>
              <option value="aid-distribution">Aid Distribution</option>
            </select>
            <button id="applyBoardFilter">Apply Filter</button>
          </div>
          <div id="recoveryBoard" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 0.5em;">
            <!-- Filtered intelligence items will be loaded here -->
            <p style="text-align: center; color: #888;">No intelligence items to display.</p>
          </div>
        </section>
      </div>
    </div>
  </main>
  <footer>
    <div style="font-weight:bold;color:#c0392b;">
      ⚠️ Not for Operational Use. For demonstration only.<br>
      Data sources: <a href="https://www.bom.gov.au/" target="_blank">Bureau of Meteorology</a>, <a href="https://afdrs.com.au/" target="_blank">AFDRS</a>, <a href="https://firms.modaps.eosdis.nasa.gov/" target="_blank">NASA FIRMS</a>
    </div>
    <p>Based on AFDRS and the <a href="https://www.australianwarningsystem.com.au/" target="_blank">Australian Warning System</a>.</p>
    <form id="feedbackForm" style="margin-top:1em;" aria-label="Feedback form">
      <label for="feedbackInput">Feedback for improvement:</label>
      <input type="text" id="feedbackInput" maxlength="200" style="width:60%;" aria-label="Feedback input" />
      <button type="submit" aria-label="Submit feedback">Submit</button>
      <span id="feedbackStatus" style="margin-left:1em;color:#1976d2;"></span>
    </form>
  </footer>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="script.js"></script>
  <script src="recovery.js"></script>
  <script>
    // Chat popup controls
    document.getElementById('openWeatherChatBtn').addEventListener('click', function() {
      document.getElementById('weatherChatPopup').style.display = 'flex';
    });
    
    document.getElementById('closeWeatherChatBtn').addEventListener('click', function() {
      document.getElementById('weatherChatPopup').style.display = 'none';
    });
    // --- Accessibility & Language ---
    document.getElementById('darkModeToggle').onclick = function() {
      document.body.classList.toggle('dark-mode');
      this.classList.toggle('active');
    };
    document.getElementById('contrastToggle').onclick = function() {
      document.body.classList.toggle('high-contrast');
      this.classList.toggle('active');
    };
    document.getElementById('languageSelect').onchange = function() {
      // Simple demo: just change html lang attribute
      document.documentElement.lang = this.value;
    };

    // --- Feedback Form ---
    document.getElementById('feedbackForm').onsubmit = function(e) {
      e.preventDefault();
      const val = document.getElementById('feedbackInput').value.trim();
      if (!val) return;
      document.getElementById('feedbackStatus').textContent = 'Thank you for your feedback!';
      setTimeout(() => { document.getElementById('feedbackStatus').textContent = ''; }, 4000);
      document.getElementById('feedbackInput').value = '';
      // Optionally send to backend
      // fetch('/api/feedback', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({feedback:val})});
    };

    // --- Alerts: Color-coded, last updated, auto-refresh ---
    let alertsLastFetched = Date.now();

    const dummyAlerts = [
      {
        title: "Bushfire Emergency Warning",
        level: "Emergency",
        status: "Immediate Threat",
        locationDesc: "PERTH METROPOLITAN, CITY OF SWAN",
        updated: Date.now() - 1000 * 60 * 5, // 5 minutes ago
        details: "There is a bushfire in your area. You are in danger and need to act immediately to survive. Leave now if the path is clear. If you cannot leave, you need to shelter."
      },
      {
        title: "Bushfire Watch and Act",
        level: "Watch and Act",
        status: "High Alert",
        locationDesc: "SOUTH WEST, SHIRE OF AUGUSTA-MARGARET RIVER",
        updated: Date.now() - 1000 * 60 * 30, // 30 minutes ago
        details: "A bushfire is burning and conditions are changing. There is a possible threat to lives and homes. Stay alert and monitor your surroundings. Prepare to leave or defend."
      },
      {
        title: "Storm Advice",
        level: "Advice",
        status: "Monitor Conditions",
        locationDesc: "LOWER SOUTH WEST, CITY OF ALBANY",
        updated: Date.now() - 1000 * 60 * 60 * 2, // 2 hours ago
        details: "A severe thunderstorm is possible. Stay informed and be aware of the situation. Take precautions such as securing loose items and preparing an emergency kit."
      },
      {
        title: "Bushfire Advice",
        level: "Advice",
        status: "Threat Reduced",
        locationDesc: "ROEBUCK, SHIRE OF BROOME",
        updated: Date.now() - 1000 * 60 * 60 * 6, // 6 hours ago
        details: "The immediate threat has passed, but remain vigilant. There may still be smoke and hazards in the area. Stay up to date with official information."
      }
    ];

    function getAlertIcon(alert) {
      if (alert.title.includes('Bushfire')) {
        return 'assets/icon-bushfire.svg';
      }
      if (alert.title.includes('Storm')) {
        return 'assets/icon-storm.svg';
      }
      // Fallback to level-based icons if no specific hazard icon
      if (alert.level === 'Emergency') {
        return 'assets/emergency-icon.svg';
      }
      if (alert.level === 'Watch and Act') {
        return 'assets/watch-icon.svg';
      }
      if (alert.level === 'Advice') {
        return 'assets/advice-icon.svg';
      }
      return 'assets/advice-icon.svg'; // Default fallback
    }

    function renderAlerts(alerts) {
      const container = document.getElementById('alertsList');
      container.innerHTML = '';
      alerts.forEach(alert => {
        const card = document.createElement('div');
        card.className = 'alert-card';
        card.setAttribute('data-level', alert.level || 'Advice');
        card.setAttribute('data-expanded', 'false'); // Default to collapsed
        card.innerHTML = `
          <div class="alert-header">
            <img src="${getAlertIcon(alert)}" alt="${alert.level} icon" class="alert-icon" width="24" height="24">
            <div class="alert-title">
              ${alert.title || 'Bushfire Alert'}
              ${(alert.level === 'Emergency' || alert.level === 'Watch and Act') ? '<span class="live-indicator"></span>' : ''}
            </div>
            <button class="toggle-btn" aria-expanded="false">▼</button>
          </div>
          <div class="alert-content">
            <div class="alert-status"><strong>Status:</strong> ${alert.status || 'Unknown'} (${alert.level || 'Advice'})</div>
            <div><strong>Location:</strong> ${alert.locationDesc || ''}</div>
            <div class="alert-updated">Updated ${timeAgo(alert.updated || Date.now())}</div>
            <p>${alert.details || 'No additional details provided.'}</p>
          </div>
        `;
        container.appendChild(card);

        // Add event listener to toggle button
        const toggleBtn = card.querySelector('.toggle-btn');
        toggleBtn.addEventListener('click', () => {
          const isExpanded = card.getAttribute('data-expanded') === 'true';
          card.setAttribute('data-expanded', !isExpanded);
          toggleBtn.setAttribute('aria-expanded', !isExpanded);
          toggleBtn.textContent = isExpanded ? '▼' : '▲';
        });
      });
      document.getElementById('alertsLastUpdated').textContent = 'Updated ' + timeAgo(alertsLastFetched);
    }
    function timeAgo(ts) {
      const now = Date.now();
      const diff = Math.floor((now - ts) / 1000);
      if (diff < 60) return `${diff}s ago`;
      if (diff < 3600) return `${Math.floor(diff/60)} mins ago`;
      return `${Math.floor(diff/3600)} hrs ago`;
    }
    
    // Function to update summary cards (dummy data)
    function updateSummaryCards(alerts) {
      // Dummy data for summary cards
      const activeFires = alerts.filter(a => a.title.includes('Bushfire') && a.level !== 'Advice').length;
      const highRiskAreas = alerts.filter(a => a.level === 'Emergency' || a.level === 'Watch and Act').length;
      const medicalResources = 5; // Example dummy value
      const weatherRisk = Math.round(Math.random() * 100); // Example dummy value

      // Update elements (if they exist, as they are commented out in HTML)
      const summaryActiveFires = document.getElementById('summaryActiveFires');
      if (summaryActiveFires) summaryActiveFires.textContent = activeFires;
      const summaryHighRisk = document.getElementById('summaryHighRisk');
      if (summaryHighRisk) summaryHighRisk.textContent = highRiskAreas;
      const summaryMedResources = document.getElementById('summaryMedResources');
      if (summaryMedResources) summaryMedResources.textContent = medicalResources;
      const summaryWeatherRisk = document.getElementById('summaryWeatherRisk');
      if (summaryWeatherRisk) summaryWeatherRisk.textContent = weatherRisk;
    }

    // Dummy function for rendering trend graphs
    function renderTrendGraph(elementId, data, color) {
      const element = document.getElementById(elementId);
      if (element) {
        element.innerHTML = `[Graph for ${elementId} with data: ${data.join(', ')}]`;
        // In a real scenario, you'd use a charting library like Chart.js or D3.js here
      }
    }

    // Dummy function for alerts feed
    function renderAlertsFeed(alerts) {
      const feedContainer = document.getElementById('alertsFeed');
      if (feedContainer) {
        feedContainer.innerHTML = `<p>Latest feed updates: ${alerts.length} new alerts.</p>`;
      }
    }

    function refreshAlerts() {
      alertsLastFetched = Date.now();
      renderAlerts(dummyAlerts);
      updateSummaryCards(dummyAlerts);
      renderTrendGraph('trendFireIncidents', [2,3,5,4,6,7,8], '#c0392b');
      renderTrendGraph('trendResourceUse', [1,2,2,3,4,3,2], '#1976d2');
      renderTrendGraph('trendMedicalCalls', [0,1,2,1,3,2,1], '#27ae60');
      renderAlertsFeed(dummyAlerts);
    }
    
    // Initial render on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      refreshAlerts(); // Call refreshAlerts to render dummy data initially
    });

    // Collapsible alerts section
    document.getElementById('toggle-alerts').onclick = function() {
      document.querySelector('.alerts-list-section').classList.toggle('collapsed');
    };

    // --- AI Weather Chat: Voice input, confidence, graph placeholder ---
    let isLoading = false;
    let recognition;
function addMessage(content, isUser = false) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;

      if (isUser) {
        messageDiv.textContent = content;
        messagesContainer.appendChild(messageDiv);
      } else {
        // Create cursor element
        const cursor = document.createElement('span');
        cursor.className = 'typing-cursor';
        cursor.textContent = '|';
        
        // Add initial cursor
        messageDiv.appendChild(cursor);
        messagesContainer.appendChild(messageDiv);
        
        // Typewriter effect
        let index = 0;
        const formattedContent = content
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\n/g, '<br>');
        
        function typeCharacter() {
          if (index < formattedContent.length) {
            messageDiv.insertBefore(
              document.createTextNode(formattedContent[index]),
              cursor
            );
            index++;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            setTimeout(typeCharacter, 20);
          } else {
            cursor.remove();
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }
        }
        
        typeCharacter();
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function addLoadingMessage() {
      const messagesContainer = document.getElementById('chatMessages');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message loading';
      loadingDiv.id = 'loading-message';
      loadingDiv.textContent = '🤖 Analyzing weather patterns...';
      messagesContainer.appendChild(loadingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function removeLoadingMessage() {
      const loadingMsg = document.getElementById('loading-message');
      if (loadingMsg) {
        loadingMsg.remove();
      }
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const sendBtn = document.getElementById('chatSendBtn');
      const message = input.value.trim();
      
      if (!message || isLoading) return;
      
      // Add user message
      addMessage(message, true);
      
      // Clear input and disable button
      input.value = '';
      sendBtn.disabled = true;
      isLoading = true;
      
      // Add loading message
      addLoadingMessage();
      
      try {
        const response = await fetch('/api/weather-chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message }),
        });
        
        if (!response.ok) {
          throw new Error('Failed to get weather prediction');
        }
        
        const data = await response.json();
        removeLoadingMessage();
        addMessage(data.response + (data.confidence ? `<br><strong>Confidence:</strong> ${data.confidence}` : ''));
        if (data.riskGraphData) renderFireRiskGraph(data.riskGraphData);
        
      } catch (error) {
        console.error('Chat error:', error);
        removeLoadingMessage();
        addMessage('Sorry, I encountered an error while processing your request. Please try again later.');
      } finally {
        sendBtn.disabled = false;
        isLoading = false;
        input.focus();
      }
    }

    function askWeatherQuestion(question) {
      document.getElementById('chatInput').value = question;
      sendMessage();
    }

    // Voice input integration
    document.getElementById('voiceBtn').onclick = function() {
      if (!('webkitSpeechRecognition' in window)) {
        alert('Voice input not supported in this browser.');
        return;
      }
      if (recognition && recognition.recognizing) {
        recognition.stop();
        this.classList.remove('listening');
        return;
      }
      recognition = new webkitSpeechRecognition();
      recognition.lang = document.documentElement.lang || 'en-US';
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.onstart = () => this.classList.add('listening');
      recognition.onend = () => this.classList.remove('listening');
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('chatInput').value = transcript;
        sendMessage();
      };
      recognition.start();
    };
    // Fire risk graph rendering (placeholder)
    function renderFireRiskGraph(data) {
      // For demo, just show JSON or simple SVG
      const graph = document.getElementById('fireRiskGraph');
      if (!data || !Array.isArray(data)) {
        graph.textContent = '[Fire risk trend graph will appear here]';
        return;
      }
      // Simple SVG line graph
      const max = Math.max(...data.map(d=>d.value));
      const min = Math.min(...data.map(d=>d.value));
      const points = data.map((d,i) => `${i*30+10},${120-((d.value-min)/(max-min+0.01))*100}`).join(' ');
      graph.innerHTML = `<svg width="100%" height="120"><polyline points="${points}" fill="none" stroke="#c0392b" stroke-width="3"/><text x="10" y="20" font-size="14" fill="#333">Risk</text></svg>`;
    }
    // Enter key support
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !isLoading) {
        sendMessage();
      }
    });

    // Auto-focus on input when page loads
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('chatInput').focus();
    });

    // --- Medical Dispatch Coordination Panel ---
    let medDispatchTab = 0;
    let medIncidentStatus = "Pending";
    let medIncidentMessages = [
      { sender: "Fire Command", text: "Medical request created.", ts: Date.now() }
    ];
    let medTriageList = [
      { name: "Patient A", level: "Yellow", ts: Date.now() },
      { name: "Patient B", level: "Green", ts: Date.now() }
    ];
    let medReport = {
      injured: 2,
      treated: 2,
      green: 1,
      yellow: 1,
      red: 0,
      transport: "Royal Perth Hospital",
      dispatchTime: Date.now() - 1000*60*8,
      arrivalTime: Date.now() - 1000*60*2,
      treatmentStart: Date.now() - 1000*60*1
    };
    let offlineQueue = [
      { type: "message", data: "Need 2 additional ambulances", ts: Date.now()-1000*60 }
    ];
    function statusBadge(status) {
      const map = {
        "Pending": 'bg-gray-200 text-gray-800',
        "En Route": 'bg-blue-100 text-blue-800',
        "On Scene": 'bg-orange-100 text-orange-800',
        "Completed": 'bg-green-100 text-green-800'
      };
      return `<span class="${map[status]||'bg-gray-200 text-gray-800'} px-2 py-1 rounded text-sm" style="font-weight:bold;">${status}</span>`;
    }
    function triageBadge(level) {
      const map = {
        "Green": 'bg-green-100 text-green-800',
        "Yellow": 'bg-yellow-100 text-yellow-800',
        "Red": 'bg-red-100 text-red-800'
      };
      return `<span class="${map[level]||'bg-gray-200 text-gray-800'} px-2 py-1 rounded text-sm">${level}</span>`;
    }
    function showMedDispatchTab(idx) {
      medDispatchTab = idx;
      document.querySelectorAll('.med-dispatch-tabs button').forEach((btn,i)=>btn.classList.toggle('active',i===idx));
      const c = document.getElementById('med-dispatch-content');
      if (idx===0) {
        // Dispatch Workflow
        c.innerHTML = `
          <div><strong>Status:</strong> ${statusBadge(medIncidentStatus)}</div>
          <div style="margin:1em 0;">
            <button onclick="setMedStatus('Pending')">🕓 Pending</button>
            <button onclick="setMedStatus('En Route')">🚑 En Route</button>
            <button onclick="setMedStatus('On Scene')">📍 On Scene</button>
            <button onclick="setMedStatus('Completed')">✅ Completed</button>
          </div>
          <div><em>${{
            "Pending":"Request created, not yet accepted.",
            "En Route":"Medical team assigned and on the way.",
            "On Scene":"Team arrived at incident location.",
            "Completed":"Incident resolved, report submitted."
          }[medIncidentStatus]}</em></div>
        `;
      } else if (idx===1) {
        // Communication Log
        c.innerHTML = `<div style="max-height:120px;overflow-y:auto;border:1px solid #eee;padding:0.5em;">
          ${medIncidentMessages.map(m=>`
            <div style="margin-bottom:0.5em;">
              <span style="font-weight:bold;">${m.sender}:</span>
              <span>${m.text}</span>
              <span style="color:#888;font-size:0.9em;">(${timeAgo(m.ts)})</span>
            </div>
          `).join('')}
        </div>
        <input type="text" id="medMsgInput" placeholder="Send message..." style="width:70%;margin-top:0.5em;" aria-label="Send message" />
        <button onclick="sendMedMessage()">Send</button>
        `;
      } else if (idx===2) {
        // Triage Tracker
        c.innerHTML = `
          <div>
            ${medTriageList.map(p=>`
              <div style="margin-bottom:0.5em;">
                <span style="font-weight:bold;">${p.name}</span>
                ${triageBadge(p.level)}
                <span style="color:#888;font-size:0.9em;">(${timeAgo(p.ts)})</span>
              </div>
            `).join('')}
          </div>
          <div style="margin-top:0.5em;">
            <input type="text" id="triageName" placeholder="Patient name" style="width:40%;" />
            <select id="triageLevel">
              <option value="Green">Green</option>
              <option value="Yellow">Yellow</option>
              <option value="Red">Red</option>
            </select>
            <button onclick="addTriage()">Add</button>
          </div>
          <div style="margin-top:1em;">
            <strong>Triage Summary:</strong>
            🟢 ${medTriageList.filter(p=>p.level==="Green").length}
            🟡 ${medTriageList.filter(p=>p.level==="Yellow").length}
            🔴 ${medTriageList.filter(p=>p.level==="Red").length}
          </div>
        `;
      } else if (idx===3) {
        // Post-Incident Report
        c.innerHTML = `
          <div><strong>Number injured:</strong> ${medReport.injured}</div>
          <div><strong>Treated:</strong> ${medReport.treated}</div>
          <div><strong>Triage breakdown:</strong> 🟢 ${medReport.green}, 🟡 ${medReport.yellow}, 🔴 ${medReport.red}</div>
          <div><strong>Transport:</strong> ${medReport.transport}</div>
          <div><strong>Dispatch → Arrival:</strong> ${Math.round((medReport.arrivalTime-medReport.dispatchTime)/60000)} min</div>
          <div><strong>Arrival → Treatment:</strong> ${Math.round((medReport.treatmentStart-medReport.arrivalTime)/60000)} min</div>
          <div style="margin-top:1em;"><em>Report auto-saved for analytics.</em></div>
        `;
      } else if (idx===4) {
        // Offline Sync
        c.innerHTML = `
          <div><strong>Offline Records Queued:</strong></div>
          <ul>
            ${offlineQueue.map(r=>`<li>${r.type}: ${r.data} <span style="color:#888;">(${timeAgo(r.ts)})</span></li>`).join('')}
          </ul>
          <div style="margin-top:1em;"><em>Records will auto-sync when connection resumes.</em></div>
        `;
      }
    }
    function setMedStatus(status) {
      medIncidentStatus = status;
      showMedDispatchTab(medDispatchTab);
    }
    function sendMedMessage() {
      const inp = document.getElementById('medMsgInput');
      const val = inp.value.trim();
      if (!val) return;
      medIncidentMessages.push({ sender: "Medical Team", text: val, ts: Date.now() });
      inp.value = '';
      showMedDispatchTab(medDispatchTab);
      // Optionally push to backend or offline queue
    }
    function addTriage() {
      const name = document.getElementById('triageName').value.trim();
      const level = document.getElementById('triageLevel').value;
      if (!name) return;
      medTriageList.push({ name, level, ts: Date.now() });
      showMedDispatchTab(medDispatchTab);
    }
    // Show first tab by default
    showMedDispatchTab(0);
    // --- Medical Integration Demo Data ---
  </script>
</body>
</html>
